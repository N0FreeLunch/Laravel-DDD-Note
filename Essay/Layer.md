## 레이어
- DDD에서 레이어드 아키텍처는 Database, Persistence, Business, Presentation 레이어로 보통 나뉜다.
- 특정 분야의 전문적인 이야기를 다룬다고 하자. 한국어를 사용하는 사람과 영어를 사용하는 사람이 있다고 하자. 두 사람은 서로 소통을 할 수 없다. 두 사람이 서로 소통하기 위해서는 통역가가 필요하다. 전문적인 내용이라 통역가는 통역만 할 수 있을 뿐, 전문적인 이야기를 나누지는 못한다. 한국어를 쓰는 사람이 전문 분야에 대해 말하는 언어가 하나의 레이어이고, 영어를 쓰는 사람이 전문 분야에 대해 말하는 언어가 하나의 레이어이다. 전문 영역에 대해서 한국어 사용자와 통역가는 서로 소통할 수 없고, 통역가와 영어 사용자는 서로 소통 할 수 없다. 하지만 한국어 사용자와 영어 사용자가 존재하고 이를 통역해 주는 통역가가 있다면 한국어 사용자와 영어 사용자는 서로 소통을 할 수 있다. 곧 서로 분리된 세계 접근할 수 없는 두 세계가 각각의 레이어에 해당하고 이 두 세계를 연결해 주는 것이 캡슐화라는 개념이다.

### 도메인의 특징
- 도메인이란 어떠한 문제를 해결하기 위해서 프로그래밍을 통해서 해결 방법을 제공하는 기능들을 서술하기 위한 것이다.
- 웹 시스템을 예로 들면 웹은 브라우저에 표현되는 유저 인터페이스를 통해서 유저가 조작한 정보를 저장해야 한다. 하지만 데이터베이스는 유저가 다룰 수 있는 대상이 아니고 보안 문제가 있기 때문에 중간에 서버 애플리케이션이라는 것을 두어 유저 인터페이스와 데이터베이스 간의 매끄러운 연결을 해 준다.
- 이 때 데이터를 데이터를 누가, 언제, 어디서, 어떻게, 무엇을, 왜 저장하는 것인지에 대한 로직을 애플리케이션 레벨에서 정할 수 있다. 이 로직이 바로 도메인에 해당한다.

### Persistence 레이어의 필요성
- 어떤 시스템을 설계하는데 있어서 애플리케이션의 상태를 변화를 저장하는 Database는 필수적이다. 하지만 데이터베이스는 쿼리 기반의 언어로 만들어져 있기 때문에 서버에서 데이터베이스의 데이터를 가져오기 위해서는 쿼리를 사용해야 한다. 쿼리 기반의 언어는 도메인 지식을 서술하는데 좋지는 않은데, 그 이유는 데이터에 테이블과 컬럼으로 이름이 붙여져 있을 뿐, 데이터를 누가, 언제, 어디서, 어떻게, 무엇을, 왜 뽑아야 하는지는 기술하기 않기 때문이다. 물론 데이터베이스의 테이블명과 컬럼 그리고 관계도를 보고 대략의 쓰임새를 유추할 수는 있지만, 웹 시스템이 제공하는 다양한 상호작용을 담아내지는 못한다. 곧 도메인을 기술하는데 불완전하기 때문에 유저와의 소통을 위한 중간의 애플리케이션을 요구한다. 애플리케이션에서 데이터베이스와의 소통을 위해 쿼리를 사용하는 것이 Persistence 레이어의 필요성이다.

### 엘로퀀트에서의 특징
- 라라벨의 모델을 이용해서 리포지토리 패턴의 클래스를 만드는 것이라면 모델은 Persistence 레이어에 해당한다. 그러나 eloquent로 사양패턴을 만드는 경우, 엘로퀀트 모델 내부는 쿼리 빌더로 구성이 되기 때문에 Persistence 레이어의 역할을 하지만, 엘로퀀트 외부로 표현되는 사양 패턴을 구현한 메소드는 도메인 로직을 나타내기 때문에 Business 레이어에 해당한다.
- 엘로퀀트 모델은 하나의 테이블에 대한 비즈니스 로직을 매핑한다. 많은 경우, 하나의 모델에 다른 모델을 참조하는 코드를 만들어 내는데, 프로그래머는 파일 및 폴더의 분리를 통해서 도메인의 경계를 어느 정도 분리하는 방법을 사용하는데 모델이 모델을 참조하게 되면서 도메인의 경계를 명확하게 나눌 수 없는 문제점이 발생하게 된다. 따라서 각 모델이 담당하는 영역이 아닌 다른 모델의 데이터를 혼합할 때는 서비스 클래스를 만들어 서로 다른 모델의 데이터를 조합하는 로직을 만드는 편이 좋다.
- 엘로퀀트 모델을 모아 놓은 폴더와 서비스 클래스를 모아 놓은 폴더는 서로 다르지만 레이어드 아키텍처의 계층적으로 보면 동일한 Business 레이어에 해당한다.

### 폴더 구조
- 레이어드 아키텍처에서 Persistence, Business, Presentation 레이어를 나눈 것은 개념적인 구분이다. Persistence에서는 데이터베이스의 쿼리 언어를 도메인을 만들기 위한 재료를 다듬는 과정이고, Business 레이어는 비즈니스의 개념을 프로그래밍 언어로 표현하는 것이다. 그리고 비즈니스의 개념들을 유저가 어떻게 사용할 수 있는지를 다루는 Presentation 레이어가 존재한다. 이들 레이어의 구분은 개념적인 구분이기 때문에 프로그래머는 좀 더 이를 명확하게 구분하기 위해서 폴더로서 각 레이어를 격리하려고 시도한다.
- 쿼리 관련 기능을 이용해서 각 도메인의 로직에서 사용되는 엔티티를 만드는 과정, 엔티티를 이용해서 도메인의 각종 개념들을 캡슐화하는 과정 그리고 이를 유저가 사용할 수 있도록 가공하는 과정은 개념적인 구분의 형태이고 이를 폴더를 통해서 각각의 기능을 분리하고 개념에 따라 폴더를 배치하는 방식을 사용한다. 이러한 구분을 통해서 프로그래머는 계층간의 차이를 더욱 쉽게 파악하고 파일 및 폴더를 더 주의하여 분리하게 된다.
- 라라벨의 엘로퀀트를 사용하면 쿼리 빌더를 통해서 쿼리를 생성할 수 있다. 엘로퀀트 객체나 클래스 내부가 아닌 외부에서 직접 쿼리를 만들 수도 있지만, 엘로퀀트 내부에서 쿼리에 대한 것을 정의하고 이를 캡슐화하여 외부에서는 도메인적인 표현의 메소드를 사용하는 방법을 쓸 수 있다. 이렇게 하면 Presentation와 Business의 개념이 엘로퀀트에 포함되어 있지만, 엘로퀀트 클래스를 정의할 때는 Persistence의 개념을 이를 사용할 때는 Business의 개념을 사용하여 레이어의 구분감을 만들어 낼 수 있다. 비록 폴더를 구분하여 프로그래머에게 명확한 레이어 분리를 보여주지는 않지만, 영속성 계층과 비즈니스 계층의 개념적인 구분을 엘로퀀트의 정의와 사용방식을 통해서 드러낼 수 있는 것이다.

### 레이어드 아키텍처를 사용하는 목적
- 레이어드 아키텍처를 사용하는 목적은 참조의 방향성을 설정하기 위해서이다. Database, Persistence, Business, Presentation의 레이어로 나누는 것은 도메인 주도 설계라는 개념에서 계층을 나눈 것이고, A라는 폴더의 클래스를 a, B라는 폴더의 클래스를 b, C라는 폴더의 클래스를 c라고 했을 때, a는 b를 사용하여 로직을 구성하고, b는 c를 사용하여 로직을 구성하는 것이다.
- 참조의 방향성을 설정하는 이유는 이러한 방향성을 정하지 않으면 참조의 방향성이 뒤죽박죽이 되면서 코드가 뒤엉킨 실처럼 되기 때문이다. 한 가닥의 긴 실을 뽑기 위해서 엉켜있는 모든 것들을 풀어야 하듯이 코드를 해석할 때도 하나하나 개념을 추적해야 하는 문제를 가지고 있다. 레이어를 통해서 참조의 방향성을 정하게 되면 하위 레이어의 구현들을 조합하여 상위 레이어의 개념을 구축하고, 하위 레이어는 좀 더 단순하고 조합할 수 있는 개념을 만들어 낼 수 있게 된다.
- 또한 프로그래밍에서 이런 방식의 레이어를 나누는 것은 각각의 레이어가 유사한 구조를 가지기 때문이다. 유사한 구조를 가지는 대상들을 모아두는 것을 통해서 일관된 코딩 스타일을 만들어 낼 수 있고 이를 통해서 이해하기 쉽고, 따라하기 쉽고, 재사용하기 쉽운 코드를 만들언 낼 수 있다.
